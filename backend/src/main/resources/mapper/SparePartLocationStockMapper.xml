<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.langdong.spare.mapper.SparePartLocationStockMapper">

    <select id="findByLocationAndSparePart" resultType="com.langdong.spare.entity.SparePartLocationStock">
        SELECT id, location_id as locationId, spare_part_id as sparePartId, quantity, updated_at as updatedAt
        FROM spare_part_location_stock
        WHERE location_id = #{locationId} AND spare_part_id = #{sparePartId}
    </select>

    <select id="findAllWithDetails" resultType="com.langdong.spare.entity.SparePartLocationStock">
        SELECT 
            s.id, 
            s.location_id as locationId, 
            s.spare_part_id as sparePartId, 
            s.quantity, 
            s.updated_at as updatedAt,
            loc.zone as locationZone,
            loc.name as locationName,
            loc.code as locationCode,
            sp.code as sparePartCode,
            sp.name as sparePartName
        FROM spare_part_location_stock s
        LEFT JOIN location loc ON s.location_id = loc.id
        LEFT JOIN spare_part sp ON s.spare_part_id = sp.id
        WHERE s.quantity > 0
        ORDER BY loc.zone ASC, loc.name ASC, s.updated_at DESC
    </select>

    <select id="sumQuantityByLocationId" resultType="java.lang.Integer">
        SELECT IFNULL(SUM(quantity), 0)
        FROM spare_part_location_stock
        WHERE location_id = #{locationId}
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO spare_part_location_stock (location_id, spare_part_id, quantity)
        VALUES (#{locationId}, #{sparePartId}, #{quantity})
    </insert>

    <update id="addQuantity">
        UPDATE spare_part_location_stock
        SET quantity = quantity + #{addedQuantity}
        WHERE location_id = #{locationId} AND spare_part_id = #{sparePartId}
    </update>

</mapper>
