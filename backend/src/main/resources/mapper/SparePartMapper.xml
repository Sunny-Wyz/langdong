<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.langdong.spare.mapper.SparePartMapper">

    <resultMap id="SparePartResultMap" type="com.langdong.spare.entity.SparePart">
        <id property="id" column="id"/>
        <result property="code" column="code"/>
        <result property="name" column="name"/>
        <result property="model" column="model"/>
        <result property="quantity" column="quantity"/>
        <result property="unit" column="unit"/>
        <result property="price" column="price"/>
        <result property="categoryId" column="category_id"/>
        <result property="supplier" column="supplier"/>
        <result property="remark" column="remark"/>
        <result property="locationId" column="location_id"/>
        <result property="supplierId" column="supplier_id"/>
        <result property="leadTime" column="lead_time"/>
        <result property="criticality" column="criticality"/>
        <result property="substitutionDifficulty" column="substitution_difficulty"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <!-- 分类模块扩展字段 -->
        <result property="isCritical" column="is_critical"/>
        <result property="replaceDiff" column="replace_diff"/>
        <result property="leadTime" column="lead_time"/>
    </resultMap>

    <select id="findAll" resultMap="SparePartResultMap">
        SELECT id, code, name, model, quantity, unit, price, category_id, supplier, remark, location_id, supplier_id, lead_time, criticality, substitution_difficulty, created_at, updated_at
        FROM spare_part
        ORDER BY created_at DESC
    </select>

    <select id="findById" resultMap="SparePartResultMap">
        SELECT id, code, name, model, quantity, unit, price, category_id, supplier, remark, location_id, supplier_id, lead_time, criticality, substitution_difficulty, created_at, updated_at
        FROM spare_part
        WHERE id = #{id}
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO spare_part (code, name, model, quantity, unit, price, category_id, supplier, remark, location_id, supplier_id, lead_time, criticality, substitution_difficulty)
        VALUES (#{code}, #{name}, #{model}, #{quantity}, #{unit}, #{price}, #{categoryId}, #{supplier}, #{remark}, #{locationId}, #{supplierId}, #{leadTime}, #{criticality}, #{substitutionDifficulty})
    </insert>

    <update id="update">
        UPDATE spare_part
        <set>
            <if test="name != null and name != ''">name = #{name},</if>
            <if test="model != null">model = #{model},</if>
            <if test="quantity != null">quantity = #{quantity},</if>
            <if test="unit != null">unit = #{unit},</if>
            <if test="price != null">price = #{price},</if>
            <if test="categoryId != null">category_id = #{categoryId},</if>
            <if test="supplier != null">supplier = #{supplier},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="locationId != null">location_id = #{locationId},</if>
            <if test="supplierId != null">supplier_id = #{supplierId},</if>
            <if test="leadTime != null">lead_time = #{leadTime},</if>
            <if test="criticality != null">criticality = #{criticality},</if>
            <if test="substitutionDifficulty != null">substitution_difficulty = #{substitutionDifficulty},</if>
        </set>
        WHERE id = #{id}
    </update>

    <delete id="deleteById">
        DELETE FROM spare_part WHERE id = #{id}
    </delete>

    <select id="findByEquipmentId" resultMap="SparePartResultMap">
        SELECT sp.id, sp.code, sp.name, sp.model, sp.quantity, sp.unit, sp.price, sp.category_id, sp.supplier, sp.remark, sp.location_id, sp.supplier_id, sp.created_at, sp.updated_at
        FROM spare_part sp
        INNER JOIN equipment_spare_part esp ON sp.id = esp.spare_part_id
        WHERE esp.equipment_id = #{equipmentId}
        ORDER BY esp.created_at DESC
    </select>

    <select id="findMaxCodeByPrefix" resultType="java.lang.String">
        SELECT MAX(code) FROM spare_part WHERE code LIKE CONCAT(#{prefix}, '%')
    </select>

    <!-- ================================================================
         分类模块专用查询
         ================================================================ -->

    <!-- 查询所有备件档案（含分类计算所需字段） -->
    <select id="findAllForClassify" resultMap="SparePartResultMap">
        SELECT id, code, name, price, is_critical, replace_diff, lead_time
        FROM spare_part
        ORDER BY code
    </select>

    <!-- 查询所有备件近12个月的月度消耗汇总
         数据来源：领用出库记录（req_status = OUTBOUND 或 INSTALLED 表示已实际出库）
         注意：out_qty 为 NULL 或 0 的明细不计入 -->
    <select id="findAllMonthlyConsumption" resultType="com.langdong.spare.dto.MonthlyConsumptionVO">
        SELECT
            sp.code                                     AS partCode,
            DATE_FORMAT(r.approve_time, '%Y-%m')        AS month,
            CAST(COALESCE(SUM(ri.out_qty), 0) AS SIGNED) AS qty
        FROM biz_requisition_item ri
        INNER JOIN biz_requisition r  ON ri.req_id = r.id
        INNER JOIN spare_part      sp ON ri.spare_part_id = sp.id
        WHERE r.req_status IN ('OUTBOUND', 'INSTALLED')
          AND ri.out_qty IS NOT NULL
          AND ri.out_qty > 0
          AND r.approve_time &gt;= #{fromMonth}
        GROUP BY sp.code, DATE_FORMAT(r.approve_time, '%Y-%m')
        ORDER BY sp.code, month
    </select>

</mapper>
