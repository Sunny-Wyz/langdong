<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.langdong.spare.mapper.SparePartMapper">

    <resultMap id="SparePartResultMap" type="com.langdong.spare.entity.SparePart">
        <id property="id" column="id"/>
        <result property="code" column="code"/>
        <result property="name" column="name"/>
        <result property="model" column="model"/>
        <result property="quantity" column="quantity"/>
        <result property="unit" column="unit"/>
        <result property="price" column="price"/>
        <result property="categoryId" column="category_id"/>
        <result property="supplier" column="supplier"/>
        <result property="remark" column="remark"/>
        <result property="locationId" column="location_id"/>
        <result property="supplierId" column="supplier_id"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <select id="findAll" resultMap="SparePartResultMap">
        SELECT id, code, name, model, quantity, unit, price, category_id, supplier, remark, location_id, supplier_id, created_at, updated_at
        FROM spare_part
        ORDER BY created_at DESC
    </select>

    <select id="findById" resultMap="SparePartResultMap">
        SELECT id, code, name, model, quantity, unit, price, category_id, supplier, remark, location_id, supplier_id, created_at, updated_at
        FROM spare_part
        WHERE id = #{id}
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO spare_part (code, name, model, quantity, unit, price, category_id, supplier, remark, location_id, supplier_id)
        VALUES (#{code}, #{name}, #{model}, #{quantity}, #{unit}, #{price}, #{categoryId}, #{supplier}, #{remark}, #{locationId}, #{supplierId})
    </insert>

    <update id="update">
        UPDATE spare_part
        <set>
            <if test="name != null and name != ''">name = #{name},</if>
            <if test="model != null">model = #{model},</if>
            <if test="quantity != null">quantity = #{quantity},</if>
            <if test="unit != null">unit = #{unit},</if>
            <if test="price != null">price = #{price},</if>
            <if test="categoryId != null">category_id = #{categoryId},</if>
            <if test="supplier != null">supplier = #{supplier},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="locationId != null">location_id = #{locationId},</if>
            <if test="supplierId != null">supplier_id = #{supplierId},</if>
        </set>
        WHERE id = #{id}
    </update>

    <delete id="deleteById">
        DELETE FROM spare_part WHERE id = #{id}
    </delete>

    <select id="findByEquipmentId" resultMap="SparePartResultMap">
        SELECT sp.id, sp.code, sp.name, sp.model, sp.quantity, sp.unit, sp.price, sp.category_id, sp.supplier, sp.remark, sp.location_id, sp.supplier_id, sp.created_at, sp.updated_at
        FROM spare_part sp
        INNER JOIN equipment_spare_part esp ON sp.id = esp.spare_part_id
        WHERE esp.equipment_id = #{equipmentId}
        ORDER BY esp.created_at DESC
    </select>

    <select id="findMaxCodeByPrefix" resultType="java.lang.String">
        SELECT MAX(code) FROM spare_part WHERE code LIKE CONCAT(#{prefix}, '%')
    </select>

</mapper>
